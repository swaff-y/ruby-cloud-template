steps:
  - label: ":package: Build, Package and run tests"
    commands:
      - "mkdir -p /Users/kyleswaffield/docker/${BUILDKITE_PIPELINE_NAME}"
      - "mkdir -p /Users/kyleswaffield/docker/${BUILDKITE_PIPELINE_NAME}/${BUILDKITE_BRANCH}"
      - "cp ./serverless.yml /Users/kyleswaffield/docker/${BUILDKITE_PIPELINE_NAME}/${BUILDKITE_BRANCH}/serverless.yml"
      - "export AWS_ACCOUNT=$(aws sts get-caller-identity | jq -r '.Account')"
      - "sh .buildkite/scripts/build_and_test.sh"
    agents:
      queue: default
    artifact_paths:
      - "/Users/kyleswaffield/docker/${BUILDKITE_PIPELINE_NAME}/${BUILDKITE_BRANCH}/serverless.yml"

  - wait: ~
    continue_on_failure: false

  - block: ':computer: Deploy stack?'

  - name: ':desert_island: Deploy'
    commands:
      - "rm serverless.yml"
      - 'buildkite-agent artifact download "Users/kyleswaffield/docker/${BUILDKITE_PIPELINE_NAME}/${BUILDKITE_BRANCH}/serverless.yml" .'
      - "cp Users/kyleswaffield/docker/${BUILDKITE_PIPELINE_NAME}/${BUILDKITE_BRANCH}/serverless.yml ."
      - "npm install"
      - "bundle install --without development test"
      - "bundle exec rake aws_login"
      - 'sls deploy > deploy_result'
      - 'cat deploy_result'
    agents:
      queue: default
    artifact_paths:
      - "deploy_result"

  - name: ':postman: postman'
    commands:
      - 'buildkite-agent artifact download "deploy_result" .'
      - "export UNIQUE_ID=$(cat deploy_result | grep -m 1 execute-api | sed 's|^.*\/\/\(.*\)\.ex.*$|\1|g')"
      - 'bundle exec rake set_unique_id'
      - 'postman collection run postman_collection.json > postman_result'
      - 'cat postman_result'
      - 'bundle exec rake postman'
    agents:
      queue: default
    artifact_paths:
      - "postman_result"

  - wait

  - block: ':hammer: Remove Stack'

  - name: ':package: Removing stack'
    commands: 
      - 'buildkite-agent artifact download "Users/kyleswaffield/docker/${BUILDKITE_PIPELINE_NAME}/${BUILDKITE_BRANCH}/serverless.yml" .'
      - "cp Users/kyleswaffield/docker/${BUILDKITE_PIPELINE_NAME}/${BUILDKITE_BRANCH}/serverless.yml ."
      - "npm install"
      - 'sls remove'
    agents:
      queue: default
